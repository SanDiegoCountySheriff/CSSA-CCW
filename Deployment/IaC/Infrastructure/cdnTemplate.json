{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "agency_abbreviation": {
      "type": "string",
      "defaultValue": "[resourceGroup().tags.agency_name]"
    },
    "agency_ori": {
      "type": "string",
      "defaultValue": "[resourceGroup().tags.agency_ori]"
    },
    "application": {
      "defaultValue": "[resourceGroup().tags.application_name]",
      "type": "string"
    },
    "dept_abbreviation": {
      "type": "string",
      "defaultValue": "[resourceGroup().tags.business_unit]"
    },
    "criticality": {
      "type": "string",
      "defaultValue": "[resourceGroup().tags.criticality]"
    },
    "data_classification": {
      "type": "string",
      "defaultValue": "[resourceGroup().tags.data_classification]"
    },
    "environment_type": {
      "type": "string",
      "defaultValue": "[resourceGroup().tags.environment]"
    },
    "owner_name": {
      "type": "string",
      "defaultValue": "[resourceGroup().tags.owner_name]"
    },
    "start_date": {
      "type": "string",
      "defaultValue": "[resourceGroup().tags.start_date]"
    },
    "instance_number": {
      "type": "string",
      "defaultValue": "001"
    },
    "user_tags": {
      "type": "Object",
      "defaultValue": {}
    },
    "global_cdn_name": {
      "defaultValue": "cssa-global-cdn",
      "type": "String"
    },
  },
  "variables": {
    "rn_cdn_endpoint": "cep",
    "rn_vnet": "vnet",
    "rn_subnet": "snet",
    "rn_nsg": "nsg",
    "rn_routetable": "rt",
    "rn_webApp": "wa",
    "rn_backendPool": "bep",
    "rn_storageacct": "sa",

    "cep_name": "[toLower(concat(variables('rn_cdn_endpoint'), '-', parameters('agency_abbreviation'), '-', parameters('dept_abbreviation'), '-', parameters('application'), '-', parameters('environment_type'), '-', parameters('instance_number')))]",
    "sa_sws_adminui_name": "[toLower(concat(variables('rn_storageacct'), parameters('agency_abbreviation'), parameters('dept_abbreviation'), parameters('application'), parameters('environment_type'), 'aui', parameters('instance_number')))]",

    "cep_admin_hostname": "[concat(variables('sa_sws_adminui_name'),'.z2.web.core.usgovcloudapi.net')]",

    "default_tags": {
      "application_name": "ccw",
      "agency": "[parameters('agency_abbreviation')]",
      "agency_ori": "[parameters('agency_ori')]",
      "business_unit": "[parameters('dept_abbreviation')]",
      "criticality": "[parameters('criticality')]",
      "data_classification": "[parameters('data_classification')]",
      "environment": "[parameters('environment_type')]",
      "owner_name": "[parameters('owner_name')]",
      "start_date": "[parameters('start_date')]"
    }
  },
  "resources": [
    {
      "type": "Microsoft.Cdn/profiles/endpoints",
      "apiVersion": "2021-06-01",
      "name": "[concat(parameters('global_cdn_name'), '/', variables('cep_name'))]",
      "location": "Global",
      "tags": "[union(variables('default_tags'), if(contains(parameters('user_tags'), 'Microsoft.Cdn/profiles/endpoints'), parameters('user_tags')['Microsoft.Cdn/profiles/endpoints'], json('{}')))]",
      "properties": {
        "originHostHeader": "[variables('cep_admin_hostname')]",
        "contentTypesToCompress": [
          "text/plain",
          "text/html",
          "text/css",
          "text/javascript",
          "application/x-javascript",
          "application/javascript",
          "application/json",
          "application/xml"
        ],
        "isCompressionEnabled": true,
        "isHttpAllowed": true,
        "isHttpsAllowed": true,
        "queryStringCachingBehavior": "IgnoreQueryString",
        "origins": [
          {
            "name": "origin-0",
            "properties": {
              "hostName": "[variables('cep_admin_hostname')]",
              "httpPort": 80,
              "httpsPort": 443,
              "originHostHeader": "[variables('cep_admin_hostname')]",
              "priority": 1,
              "weight": 1000,
              "enabled": true
            }
          }
        ],
        "originGroups": [],
        "geoFilters": [],
        "deliveryPolicy": {
          "description": "delivery_policy",
          "rules": [
            {
              "name": "HttpRedirect",
              "order": 1,
              "conditions": [
                {
                  "name": "RequestScheme",
                  "parameters": {
                    "typeName": "DeliveryRuleRequestSchemeConditionParameters",
                    "matchValues": [
                      "HTTP"
                    ],
                    "operator": "Equal",
                    "negateCondition": false,
                    "transforms": []
                  }
                }
              ],
              "actions": [
                {
                  "name": "UrlRedirect",
                  "parameters": {
                    "typeName": "DeliveryRuleUrlRedirectActionParameters",
                    "redirectType": "PermanentRedirect",
                    "destinationProtocol": "Https"
                  }
                }
              ]
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.Cdn/profiles/endpoints/customdomains",
      "apiVersion": "2021-06-01",
      "name": "[concat(parameters('global_cdn_name'), '/cep-admin-sdsd-it-ccw-dev-002/ccw-pt-admin-cssa-cloud')]",
      "dependsOn": [
        "[resourceId('Microsoft.Cdn/profiles/endpoints', parameters('global_cdn_name'), 'cep-admin-sdsd-it-ccw-dev-002')]"
      ],
      "properties": {
        "hostName": "ccw-pt-admin.cssa.cloud"
      }
    },
    {
      "type": "Microsoft.Cdn/profiles/endpoints/origins",
      "apiVersion": "2021-06-01",
      "name": "[concat(parameters('global_cdn_name'), '/cep-admin-sdsd-it-ccw-dev-002/origin-0')]",
      "dependsOn": [
        "[resourceId('Microsoft.Cdn/profiles/endpoints', parameters('global_cdn_name'), 'cep-admin-sdsd-it-ccw-dev-002')]"
      ],
      "properties": {
        "hostName": "[variables('cep_admin_hostname')]",
        "httpPort": 80,
        "httpsPort": 443,
        "originHostHeader": "[variables('cep_admin_hostname')]",
        "priority": 1,
        "weight": 1000,
        "enabled": true
      }
    }
  ]
}