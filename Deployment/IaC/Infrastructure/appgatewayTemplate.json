{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "location": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]"
    },
    "agency_abbreviation": {
      "type": "string",
      "defaultValue": "[resourceGroup().tags.agency_name]"
    },
    "agency_ori": {
      "type": "string",
      "defaultValue": "[resourceGroup().tags.agency_ori]"
    },
    "application": {
      "defaultValue": "[resourceGroup().tags.application_name]",
      "type": "string"
    },
    "dept_abbreviation": {
      "type": "string",
      "defaultValue": "[resourceGroup().tags.business_unit]"
    },
    "criticality": {
      "type": "string",
      "defaultValue": "[resourceGroup().tags.criticality]"
    },
    "data_classification": {
      "type": "string",
      "defaultValue": "[resourceGroup().tags.data_classification]"
    },
    "environment_type": {
      "type": "string",
      "defaultValue": "[resourceGroup().tags.environment]"
    },
    "owner_name": {
      "type": "string",
      "defaultValue": "[resourceGroup().tags.owner_name]"
    },
    "start_date": {
      "type": "string",
      "defaultValue": "[resourceGroup().tags.start_date]"
    },
    "instance_number": {
      "type": "string",
      "defaultValue": "001"
    },
    "user_tags": {
      "type": "Object",
      "defaultValue": {}
    },
    "vnet_addressprefixes": {
      "type": "array",
      "defaultValue": [ "172.16.20.0/23" ]
    },
    "ag_subnet_addressprefix": {
      "defaultValue": "172.16.20.0/24",
      "type": "string"
    },
    "ag_private_ip_address": {
      "type": "string",
      "defaultValue": "172.16.20.4"
    },
    "ag_sku_size": {
      "type": "string",
      "defaultValue": "Small",
      "allowedValues": [
        "Small",
        "Medium",
        "Large"
      ]
    },
    "ag_sku_instance_count": {
      "type": "string",
      "defaultValue": "2"
    }
  },
  "variables": {
    "rn_appGateway": "ag",
    "rn_vnet": "vnet",
    "rn_subnet": "snet",
    "rn_nsg": "nsg",
    "rn_routetable": "rt",
    "rn_webApp": "wa",
    "rn_backendPool": "bep",

    "ag_name": "[toLower(concat(variables('rn_appGateway'), '-', parameters('agency_abbreviation'), '-', parameters('dept_abbreviation'), '-', parameters('application'), '-', parameters('environment_type'), '-', parameters('instance_number')))]",
    "rt_name": "[toLower(concat(variables('rn_routetable'), '-', parameters('agency_abbreviation'), '-', parameters('dept_abbreviation'), '-', parameters('application'), '-', parameters('environment_type'), '-', parameters('instance_number')))]",
    "vnet_name": "[toLower(concat(variables('rn_vnet'), '-', parameters('agency_abbreviation'), '-', parameters('dept_abbreviation'), '-', parameters('application'), '-', parameters('environment_type'), '-', parameters('instance_number')))]",
    "sn_ag_name": "[toLower(concat(variables('rn_subnet'), '-', parameters('agency_abbreviation'), '-', parameters('dept_abbreviation'), '-', parameters('application'), '-', parameters('environment_type'), '-ag-', parameters('instance_number')))]",
    "nsg_ag_name": "[toLower(concat(variables('rn_nsg'), '-', parameters('agency_abbreviation'), '-', parameters('dept_abbreviation'), '-', parameters('application'), '-', parameters('environment_type'), '-ag-', parameters('instance_number')))]",

    "ag_sku_name": "[concat('Standard', '_',parameters('ag_sku_size'))]",

    "wa_admin_name": "[toLower(concat(variables('rn_webApp'), '-', parameters('agency_abbreviation'), '-', parameters('dept_abbreviation'), '-', parameters('application'), '-', parameters('environment_type'), '-admin-', parameters('instance_number')))]",
    "wa_application_name": "[toLower(concat(variables('rn_webApp'), '-', parameters('agency_abbreviation'), '-', parameters('dept_abbreviation'), '-', parameters('application'), '-', parameters('environment_type'), '-application-', parameters('instance_number')))]",
    "wa_document_name": "[toLower(concat(variables('rn_webApp'), '-', parameters('agency_abbreviation'), '-', parameters('dept_abbreviation'), '-', parameters('application'), '-', parameters('environment_type'), '-document-', parameters('instance_number')))]",
    "wa_payment_name": "[toLower(concat(variables('rn_webApp'), '-', parameters('agency_abbreviation'), '-', parameters('dept_abbreviation'), '-', parameters('application'), '-', parameters('environment_type'), '-payment-', parameters('instance_number')))]",
    "wa_schedule_name": "[toLower(concat(variables('rn_webApp'), '-', parameters('agency_abbreviation'), '-', parameters('dept_abbreviation'), '-', parameters('application'), '-', parameters('environment_type'), '-schedule-', parameters('instance_number')))]",
    "wa_userprofile_name": "[toLower(concat(variables('rn_webApp'), '-', parameters('agency_abbreviation'), '-', parameters('dept_abbreviation'), '-', parameters('application'), '-', parameters('environment_type'), '-userprofile-', parameters('instance_number')))]",

    "bep_admin_name": "[toLower(concat(variables('rn_backendPool'), '-', parameters('application'), '-', parameters('environment_type'), '-admin-', parameters('instance_number')))]",
    "bep_application_name": "[toLower(concat(variables('rn_backendPool'), '-', parameters('application'), '-', parameters('environment_type'), '-application-', parameters('instance_number')))]",
    "bep_document_name": "[toLower(concat(variables('rn_backendPool'), '-', parameters('application'), '-', parameters('environment_type'), '-document-', parameters('instance_number')))]",
    "bep_payment_name": "[toLower(concat(variables('rn_backendPool'), '-', parameters('application'), '-', parameters('environment_type'), '-payment-', parameters('instance_number')))]",
    "bep_schedule_name": "[toLower(concat(variables('rn_backendPool'), '-', parameters('application'), '-', parameters('environment_type'), '-schedule-', parameters('instance_number')))]",
    "bep_userprofile_name": "[toLower(concat(variables('rn_backendPool'), '-', parameters('application'), '-', parameters('environment_type'), '-userprofile-', parameters('instance_number')))]",

    "listener_hostname": "[toLower(concat(parameters('application'), '-api-', parameters('environment_type'), parameters('instance_number'), '.cssa.cloud'))]",

    "default_tags": {
      "application_name": "ccw",
      "agency": "[parameters('agency_abbreviation')]",
      "agency_ori": "[parameters('agency_ori')]",
      "business_unit": "[parameters('dept_abbreviation')]",
      "criticality": "[parameters('criticality')]",
      "data_classification": "[parameters('data_classification')]",
      "environment": "[parameters('environment_type')]",
      "owner_name": "[parameters('owner_name')]",
      "start_date": "[parameters('start_date')]"
    }
  },
  "resources": [
    {
      "type": "Microsoft.Network/networkSecurityGroups",
      "apiVersion": "2020-11-01",
      "name": "[variables('nsg_ag_name')]",
      "location": "[parameters('location')]",
      "tags": "[union(variables('default_tags'), if(contains(parameters('user_tags'), 'Microsoft.Network/networkSecurityGroups'), parameters('user_tags')['Microsoft.Network/networkSecurityGroups'], json('{}')))]",
      "properties": {
        "securityRules": [
          {
            "name": "AppGatewayInboundFirewallManagement",
            "properties": {
              "protocol": "*",
              "sourcePortRange": "*",
              "destinationPortRange": "65200-65353",
              "sourceAddressPrefix": "Internet",
              "destinationAddressPrefix": "*",
              "access": "Allow",
              "priority": 4035,
              "direction": "Inbound",
              "sourcePortRanges": [],
              "destinationPortRanges": [],
              "sourceAddressPrefixes": [],
              "destinationAddressPrefixes": []
            }
          },
          {
            "name": "AllowGatewayManager65200-65535Inbound",
            "properties": {
              "protocol": "*",
              "sourcePortRange": "*",
              "destinationPortRange": "65200-65535",
              "sourceAddressPrefix": "GatewayManager",
              "destinationAddressPrefix": "*",
              "access": "Allow",
              "priority": 100,
              "direction": "Inbound",
              "sourcePortRanges": [],
              "destinationPortRanges": [],
              "sourceAddressPrefixes": [],
              "destinationAddressPrefixes": []
            }
          },
          {
            "name": "AllowAzureLoadBalancerAnyInbound",
            "properties": {
              "protocol": "*",
              "sourcePortRange": "*",
              "destinationPortRange": "*",
              "sourceAddressPrefix": "AzureLoadBalancer",
              "destinationAddressPrefix": "*",
              "access": "Allow",
              "priority": 4065,
              "direction": "Inbound",
              "sourcePortRanges": [],
              "destinationPortRanges": [],
              "sourceAddressPrefixes": [],
              "destinationAddressPrefixes": []
            }
          }
        ]
      }
    },
    {
      "type": "Microsoft.Network/routeTables",
      "apiVersion": "2022-05-01",
      "name": "[variables('rt_name')]",
      "location": "[parameters('location')]",
      "dependsOn": [],
      "tags": "[union(variables('default_tags'), if(contains(parameters('user_tags'), 'Microsoft.Network/virtualNetworks'), parameters('user_tags')['Microsoft.Network/virtualNetworks'], json('{}')))]",
      "properties": {
        "disableBgpRoutePropagation": true,
        "routes": [
          {
            "name": "default-ag-next-hop",
            "properties": {
              "addressPrefix": "0.0.0.0/0",
              "nextHopType": "Internet",
              "hasBgpOverride": false
            }
          }
        ]
      }
    },
    {
      "type": "Microsoft.Network/virtualNetworks",
      "apiVersion": "2020-11-01",
      "name": "[variables('vnet_name')]",
      "location": "[parameters('location')]",
      "dependsOn": [
        "[resourceId('Microsoft.Network/networkSecurityGroups', variables('nsg_ag_name'))]",
        "[resourceId('Microsoft.Network/routeTables',variables('rt_name'))]"
      ],
      "tags": "[union(variables('default_tags'), if(contains(parameters('user_tags'), 'Microsoft.Network/virtualNetworks'), parameters('user_tags')['Microsoft.Network/virtualNetworks'], json('{}')))]",
      "properties": {
        "addressSpace": {
          "addressPrefixes": "[parameters('vnet_addressprefixes')]"
        },
        "subnets": [
          {
            "name": "[variables('sn_ag_name')]",
            "properties": {
              "addressPrefix": "[parameters('ag_subnet_addressprefix')]",
              "networkSecurityGroup": {
                "id": "[resourceId('Microsoft.Network/networkSecurityGroups', variables('nsg_ag_name'))]"
              },
              "serviceEndpoints": [
                {
                  "service": "Microsoft.Web",
                  "locations": [
                    "*"
                  ]
                }
              ],
              "delegations": [],
              "privateEndpointNetworkPolicies": "Disabled",
              "privateLinkServiceNetworkPolicies": "Enabled"
            }
          }
        ],
        "virtualNetworkPeerings": [],
        "enableDdosProtection": false
      }
    },
    {
      "type": "Microsoft.Network/applicationGateways",
      "apiVersion": "2022-05-01",
      "name": "[variables('ag_name')]",
      "location": "[parameters('location')]",
      "dependsOn": [
        "[resourceId('Microsoft.Network/virtualNetworks',variables('vnet_name'))]"
      ],
      "tags": "[union(variables('default_tags'), if(contains(parameters('user_tags'), 'Microsoft.Network/applicationGateways'), parameters('user_tags')['Microsoft.Network/applicationGateways'], json('{}')))]",
      "properties": {
        "sku": {
          "name": "[variables('ag_sku_name')]",
          "tier": "[parameters('ag_sku_tier')]",
          "capacity": "[parameters('ag_sku_instance_count')]"
        },
        "gatewayIPConfigurations": [
          {
            "name": "appGatewayIpConfig",
            "properties": {
              "subnet": {
                "id": "[resourceId('Microsoft.Network/virtualNetworks/subnets',variables('vnet_name'),variables('sn_ag_name'))]"
              }
            }
          }
        ],
        "sslCertificates": [
          {
            "name": "star-cssa-cloud",
            "properties": {}
          }
        ],
        "authenticationCertificates": [],
        "frontendIPConfigurations": [
          {
            "name": "appGwPrivateFrontendIp",
            "properties": {
              "privateIPAddress": "[parameters('ag_private_ip_address')]",
              "privateIPAllocationMethod": "Static",
              "subnet": {
                "id": "[resourceId('Microsoft.Network/virtualNetworks/subnets',variables('vnet_name'),variables('sn_ag_name'))]"
              }
            }
          }
        ],
        "frontendPorts": [
          {
            "name": "port_443",
            "properties": {
              "port": 443
            }
          },
          {
            "name": "port_80",
            "properties": {
              "port": 80
            }
          }
        ],
        "backendAddressPools": [
          {
            "name": "default-backend-pool-to-nowhere",
            "properties": {
              "backendAddresses": []
            }
          },
          {
            "name": "[variables('bep_application_name')]",
            "properties": {
              "backendAddresses": [
                {
                  "fqdn": "[concat(variables('wa_application_name'),'.azurewebsites.us')]"
                }
              ]
            }
          },
          {
            "name": "[variables('bep_document_name')]",
            "properties": {
              "backendAddresses": [
                {
                  "fqdn": "[concat(variables('wa_document_name'),'.azurewebsites.us')]"
                }
              ]
            }
          },
          {
            "name": "[variables('bep_payment_name')]",
            "properties": {
              "backendAddresses": [
                {
                  "fqdn": "[concat(variables('wa_payment_name'),'.azurewebsites.us')]"
                }
              ]
            }
          },
          {
            "name": "[variables('bep_schedule_name')]",
            "properties": {
              "backendAddresses": [
                {
                  "fqdn": "[concat(variables('wa_schedule_name'),'.azurewebsites.us')]"
                }
              ]
            }
          },
          {
            "name": "[variables('bep_userprofile_name')]",
            "properties": {
              "backendAddresses": [
                {
                  "fqdn": "[concat(variables('wa_userprofile_name'),'.azurewebsites.us')]"
                }
              ]
            }
          },
          {
            "name": "[variables('bep_admin_name')]",
            "properties": {
              "backendAddresses": [
                {
                  "fqdn": "[concat(variables('wa_admin_name'),'.azurewebsites.us')]"
                }
              ]
            }
          }
        ],
        "backendHttpSettingsCollection": [
          {
            "name": "application-https-backend-settings",
            "properties": {
              "port": 443,
              "protocol": "Https",
              "cookieBasedAffinity": "Disabled",
              "pickHostNameFromBackendAddress": true,
              "affinityCookieName": "ApplicationGatewayAffinity",
              "requestTimeout": 20,
              "probe": {
                "id": "[concat(resourceId('Microsoft.Network/applicationGateways', variables('ag_name')), '/probes/basic-https-health-probe')]"
              }
            }
          }
        ],
        "httpListeners": [
          {
            "name": "ccw-private-https-listener",
            "properties": {
              "frontendIPConfiguration": {
                "id": "[concat(resourceId('Microsoft.Network/applicationGateways', variables('ag_name')), '/frontendIPConfigurations/appGwPrivateFrontendIp')]"
              },
              "frontendPort": {
                "id": "[concat(resourceId('Microsoft.Network/applicationGateways', variables('ag_name')), '/frontendPorts/port_443')]"
              },
              "protocol": "Https",
              "sslCertificate": {
                "id": "[concat(resourceId('Microsoft.Network/applicationGateways', variables('ag_name')), '/sslCertificates/star-cssa-cloud')]"
              },
              "hostName": "[variables('listener_hostname')]",
              "hostNames": [],
              "requireServerNameIndication": true
            }
          },
          {
            "name": "ccw-private-http-listener",
            "id": "[concat(resourceId('Microsoft.Network/applicationGateways', variables('ag_name')), '/httpListeners/ccw-private-http-listener')]",
            "properties": {
              "frontendIPConfiguration": {
                "id": "[concat(resourceId('Microsoft.Network/applicationGateways', variables('ag_name')), '/frontendIPConfigurations/appGwPrivateFrontendIp')]"
              },
              "frontendPort": {
                "id": "[concat(resourceId('Microsoft.Network/applicationGateways', variables('ag_name')), '/frontendPorts/port_80')]"
              },
              "protocol": "Http",
              "hostName": "[variables('listener_hostname')]",
              "hostNames": [],
              "requireServerNameIndication": false
            }
          }
        ],
        "urlPathMaps": [
          {
            "name": "ccw-dev-002-https-path-routing-rule",
            "properties": {
              "defaultBackendAddressPool": {
                "id": "[concat(resourceId('Microsoft.Network/applicationGateways', variables('ag_name')), '/backendAddressPools/default-backend-pool-to-nowhere')]"
              },
              "defaultBackendHttpSettings": {
                "id": "[concat(resourceId('Microsoft.Network/applicationGateways', variables('ag_name')), '/backendHttpSettingsCollection/application-https-backend-settings')]"
              },
              "pathRules": [
                {
                  "name": "ccw-dev-002-backend-target-payment",
                  "properties": {
                    "paths": [
                      "/payment/*"
                    ],
                    "backendAddressPool": {
                      "id": "[concat(resourceId('Microsoft.Network/applicationGateways', variables('ag_name')), '/backendAddressPools/ccw-dev-bep-payment-002')]"
                    },
                    "backendHttpSettings": {
                      "id": "[concat(resourceId('Microsoft.Network/applicationGateways', variables('ag_name')), '/backendHttpSettingsCollection/application-https-backend-settings')]"
                    }
                  }
                },
                {
                  "name": "ccw-dev-002-backend-target-userprofile",
                  "id": "[concat(resourceId('Microsoft.Network/applicationGateways', variables('ag_name')), '/urlPathMaps/ccw-dev-002-https-path-routing-rule/pathRules/ccw-dev-002-backend-target-userprofile')]",
                  "properties": {
                    "paths": [
                      "/userprofile/*"
                    ],
                    "backendAddressPool": {
                      "id": "[concat(resourceId('Microsoft.Network/applicationGateways', variables('ag_name')), '/backendAddressPools/ccw-dev-bep-userprofile-002')]"
                    },
                    "backendHttpSettings": {
                      "id": "[concat(resourceId('Microsoft.Network/applicationGateways', variables('ag_name')), '/backendHttpSettingsCollection/application-https-backend-settings')]"
                    }
                  }
                },
                {
                  "name": "ccw-dev-002-backend-target-schedule",
                  "id": "[concat(resourceId('Microsoft.Network/applicationGateways', variables('ag_name')), '/urlPathMaps/ccw-dev-002-https-path-routing-rule/pathRules/ccw-dev-002-backend-target-schedule')]",
                  "properties": {
                    "paths": [
                      "/schedule/*"
                    ],
                    "backendAddressPool": {
                      "id": "[concat(resourceId('Microsoft.Network/applicationGateways', variables('ag_name')), '/backendAddressPools/ccw-dev-bep-schedule-002')]"
                    },
                    "backendHttpSettings": {
                      "id": "[concat(resourceId('Microsoft.Network/applicationGateways', variables('ag_name')), '/backendHttpSettingsCollection/application-https-backend-settings')]"
                    }
                  }
                },
                {
                  "name": "ccw-dev-002-backend-target-admin",
                  "id": "[concat(resourceId('Microsoft.Network/applicationGateways', variables('ag_name')), '/urlPathMaps/ccw-dev-002-https-path-routing-rule/pathRules/ccw-dev-002-backend-target-admin')]",
                  "properties": {
                    "paths": [
                      "/admin/*"
                    ],
                    "backendAddressPool": {
                      "id": "[concat(resourceId('Microsoft.Network/applicationGateways', variables('ag_name')), '/backendAddressPools/ccw-dev-bep-admin-002')]"
                    },
                    "backendHttpSettings": {
                      "id": "[concat(resourceId('Microsoft.Network/applicationGateways', variables('ag_name')), '/backendHttpSettingsCollection/application-https-backend-settings')]"
                    }
                  }
                },
                {
                  "name": "ccw-dev-002-backend-target-application",
                  "id": "[concat(resourceId('Microsoft.Network/applicationGateways', variables('ag_name')), '/urlPathMaps/ccw-dev-002-https-path-routing-rule/pathRules/ccw-dev-002-backend-target-application')]",
                  "properties": {
                    "paths": [
                      "/application/*"
                    ],
                    "backendAddressPool": {
                      "id": "[concat(resourceId('Microsoft.Network/applicationGateways', variables('ag_name')), '/backendAddressPools/ccw-dev-bep-application-002')]"
                    },
                    "backendHttpSettings": {
                      "id": "[concat(resourceId('Microsoft.Network/applicationGateways', variables('ag_name')), '/backendHttpSettingsCollection/application-https-backend-settings')]"
                    }
                  }
                },
                {
                  "name": "ccw-dev-002-backend-target-document",
                  "id": "[concat(resourceId('Microsoft.Network/applicationGateways', variables('ag_name')), '/urlPathMaps/ccw-dev-002-https-path-routing-rule/pathRules/ccw-dev-002-backend-target-document')]",
                  "properties": {
                    "paths": [
                      "/document/*"
                    ],
                    "backendAddressPool": {
                      "id": "[concat(resourceId('Microsoft.Network/applicationGateways', variables('ag_name')), '/backendAddressPools/ccw-dev-bep-document-002')]"
                    },
                    "backendHttpSettings": {
                      "id": "[concat(resourceId('Microsoft.Network/applicationGateways', variables('ag_name')), '/backendHttpSettingsCollection/application-https-backend-settings')]"
                    }
                  }
                }
              ]
            }
          }
        ],
        "requestRoutingRules": [
          {
            "name": "ccw-dev-002-http-redirect-https-routing-rule",
            "id": "[concat(resourceId('Microsoft.Network/applicationGateways', variables('ag_name')), '/requestRoutingRules/ccw-dev-002-http-redirect-https-routing-rule')]",
            "properties": {
              "ruleType": "Basic",
              "httpListener": {
                "id": "[concat(resourceId('Microsoft.Network/applicationGateways', variables('ag_name')), '/httpListeners/ccw-private-http-listener')]"
              },
              "redirectConfiguration": {
                "id": "[concat(resourceId('Microsoft.Network/applicationGateways', variables('ag_name')), '/redirectConfigurations/ccw-dev-002-http-redirect-https-routing-rule')]"
              }
            }
          },
          {
            "name": "ccw-dev-002-https-path-routing-rule",
            "id": "[concat(resourceId('Microsoft.Network/applicationGateways', variables('ag_name')), '/requestRoutingRules/ccw-dev-002-https-path-routing-rule')]",
            "properties": {
              "ruleType": "PathBasedRouting",
              "httpListener": {
                "id": "[concat(resourceId('Microsoft.Network/applicationGateways', variables('ag_name')), '/httpListeners/ccw-private-https-listener')]"
              },
              "urlPathMap": {
                "id": "[concat(resourceId('Microsoft.Network/applicationGateways', variables('ag_name')), '/urlPathMaps/ccw-dev-002-https-path-routing-rule')]"
              }
            }
          }
        ],
        "probes": [
          {
            "name": "basic-https-health-probe",
            "id": "[concat(resourceId('Microsoft.Network/applicationGateways', variables('ag_name')), '/probes/basic-https-health-probe')]",
            "properties": {
              "protocol": "Https",
              "path": "/health",
              "interval": 30,
              "timeout": 10,
              "unhealthyThreshold": 3,
              "pickHostNameFromBackendHttpSettings": true,
              "minServers": 0,
              "match": {
                "statusCodes": [
                  "200-399"
                ]
              }
            }
          }
        ],
        "rewriteRuleSets": [],
        "redirectConfigurations": [
          {
            "name": "ccw-dev-002-http-redirect-https-routing-rule",
            "id": "[concat(resourceId('Microsoft.Network/applicationGateways', variables('ag_name')), '/redirectConfigurations/ccw-dev-002-http-redirect-https-routing-rule')]",
            "properties": {
              "redirectType": "Permanent",
              "targetListener": {
                "id": "[concat(resourceId('Microsoft.Network/applicationGateways', variables('ag_name')), '/httpListeners/ccw-private-https-listener')]"
              },
              "includePath": true,
              "includeQueryString": true,
              "requestRoutingRules": [
                {
                  "id": "[concat(resourceId('Microsoft.Network/applicationGateways', variables('ag_name')), '/requestRoutingRules/ccw-dev-002-http-redirect-https-routing-rule')]"
                }
              ]
            }
          }
        ],
        "enableHttp2": false
      }
    }
  ]
}